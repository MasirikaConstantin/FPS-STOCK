import{r as d,K as V,m as H,j as e,L as z,t as G}from"./app-CQvyAInf.js";import{B as P}from"./button-qelRmArg.js";import{I as N}from"./input-Blf29Qex.js";import{L as x}from"./label-DXuQz94P.js";import{S as W,a as X,b as K,c as O,d as $}from"./select-DsVvSlVc.js";import{T as J,a as U,b as C,c as h,d as Y,e as j}from"./table-Bx0a_80k.js";import{A as Z}from"./app-layout-mQZNAdUE.js";import{A as q,b as w}from"./alert-BOo9Omnq.js";import{B as ee}from"./badge-CsRI51Hc.js";import{C as te,a as se,b as ae,c as re}from"./card-D2Gq_jtJ.js";import{C as D}from"./circle-alert-MX2DQFDa.js";import{W as ie}from"./warehouse-DhFqhBwI.js";import{M as ne}from"./minus-BAwguQ3J.js";import"./app-CbyD8i4Z.js";import"./index-Dh4Dnqzu.js";import"./utils-jAU0Cazi.js";import"./index-Csg-B5yo.js";import"./index-D1Z7h3vH.js";import"./createLucideIcon-CDtDhRNb.js";import"./check-3WY5HJZB.js";import"./index-B6QC96uA.js";import"./app-logo-icon-CYEPLqCw.js";import"./car-front-3ODHaHDz.js";import"./package-BH85mpxF.js";function Re({products:y,auth:oe}){var A;const[i,E]=d.useState(null),[l,T]=d.useState(0),[m,f]=d.useState([]),[g,v]=d.useState(0),[_,S]=d.useState(null),{flash:le,error:ce}=V().props,{data:b,setData:u,post:L,processing:R,reset:F}=H({product_id:"",allocations:[],raison:"",notes:""});d.useEffect(()=>{i&&l>0&&I()},[i,l]);const I=()=>{var c;if(!i)return;const t=((c=i.stocks)==null?void 0:c.filter(s=>s.quantite>0))||[];if(t.length===0){S("Ce produit n'a aucun stock disponible"),f([]),v(l);return}else S(null);let a=l;const r=[],o=[...t].sort((s,n)=>{if(!s.hopital&&n.hopital)return-1;if(s.hopital&&!n.hopital)return 1;const p=s.date_expiration?new Date(s.date_expiration).getTime():Number.MAX_SAFE_INTEGER,k=n.date_expiration?new Date(n.date_expiration).getTime():Number.MAX_SAFE_INTEGER;return p-k});for(const s of o){if(a<=0)break;const n=Math.min(s.quantite,a);r.push({stock_id:s.id,quantity:n,hopital:s.hopital,numero_lot:s.numero_lot,date_expiration:s.date_expiration,max:s.quantite,isDepotCentral:!s.hopital}),a-=n}f(r),v(a),u("allocations",r)},M=(t,a)=>{var n;const r=parseInt(a)||0,o=(n=i==null?void 0:i.stocks)==null?void 0:n.find(p=>p.id===m[t].stock_id);if(!o)return;if(r>o.quantite){alert(`La quantité ne peut pas dépasser ${o.quantite} pour ce stock`);return}const c=[...m];c[t].quantity=r,f(c);const s=c.reduce((p,k)=>p+k.quantity,0);v(l-s),u("allocations",c)},B=t=>{if(t.preventDefault(),g>0){alert("Vous devez répartir toute la quantité demandée avant de soumettre");return}L(route("stock.mouvements.direct-out"),{onSuccess:()=>F(),onError:()=>G.error("Le texte de raison ne peut pas contenir plus de 255 caractères.")})},Q=[{title:"Stock",href:route("stocks.index")},{title:"Mouvement Stock",href:route("stock.mouvements.index")},{title:"Sortie Directe",href:route("stock.mouvements.direct-out.index")}];return e.jsxs(Z,{breadcrumbs:Q,children:[e.jsx(z,{title:"Sortie Directe de Stock"}),e.jsx("div",{className:"py-12",children:e.jsx("div",{className:"mx-auto max-w-7xl sm:px-6 lg:px-8",children:e.jsx("div",{className:"overflow-hidden shadow-sm sm:rounded-lg",children:e.jsxs(te,{children:[e.jsx(se,{className:"flex flex-row items-center justify-between space-y-0",children:e.jsx(ae,{className:"text-2xl font-bold",children:"Sortie Directe de Stock"})}),e.jsx(re,{children:e.jsxs("form",{onSubmit:B,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"product",children:"Produit"}),e.jsxs(W,{onValueChange:t=>{const a=y.find(r=>r.id.toString()===t);E(a||null),u("product_id",t),f([]),v(0),S(null)},value:b.product_id,children:[e.jsx(X,{children:e.jsx(K,{placeholder:"Sélectionner un produit"})}),e.jsx(O,{children:y.map(t=>{var a,r;return e.jsxs($,{value:t.id.toString(),disabled:!((a=t.stocks)!=null&&a.some(o=>o.quantite>0)),children:[t.name,!((r=t.stocks)!=null&&r.some(o=>o.quantite>0))&&" (Stock épuisé)"]},t.id)})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"quantity",children:"Quantité nécessaire"}),e.jsx(N,{id:"quantity",type:"number",min:"1",value:l,onChange:t=>T(Math.max(0,parseInt(t.target.value)||0)),disabled:!i})]})]}),_&&e.jsxs(q,{variant:"destructive",children:[e.jsx(D,{className:"h-4 w-4"}),e.jsx(w,{children:_})]}),i&&l>0&&e.jsxs("div",{className:"space-y-4",children:[m.length>0?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Répartition des stocks"}),e.jsxs(J,{children:[e.jsx(U,{children:e.jsxs(C,{children:[e.jsx(h,{children:"Source"}),e.jsx(h,{children:"Lot"}),e.jsx(h,{children:"Expiration"}),e.jsx(h,{children:"Disponible"}),e.jsx(h,{children:"À prélever"})]})}),e.jsx(Y,{children:m.map((t,a)=>e.jsxs(C,{children:[e.jsx(j,{children:e.jsx("div",{className:"flex items-center gap-2",children:t.hopital?t.hopital.nom:e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"h-4 w-4 text-blue-500"}),e.jsx("span",{children:"Dépôt central"}),e.jsx(ee,{variant:"outline",className:"ml-2",children:"Central"})]})})}),e.jsx(j,{children:t.numero_lot||"N/A"}),e.jsx(j,{children:t.date_expiration?new Date(t.date_expiration).toLocaleDateString():"N/A"}),e.jsx(j,{children:t.max}),e.jsx(j,{children:e.jsx(N,{type:"number",min:"0",max:t.max,value:t.quantity,onChange:r=>M(a,r.target.value)})})]},t.stock_id))})]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"text-sm",children:["Restant à prélever: ",e.jsx("span",{className:"font-bold",children:g})]}),g===0&&e.jsx("div",{className:"text-sm text-green-600",children:"Quantité totalement allouée"})]})]}):e.jsxs(q,{variant:"destructive",children:[e.jsx(D,{className:"h-4 w-4"}),e.jsxs(w,{children:["Pas assez de stock disponible pour ce produit. Stock total: ",((A=i.stocks)==null?void 0:A.reduce((t,a)=>t+a.quantite,0))||0]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"reason",children:"Raison"}),e.jsx(N,{id:"reason",value:b.raison,max:255,maxLength:254,onChange:t=>u("raison",t.target.value),placeholder:"Raison de la sortie",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"notes",children:"Notes"}),e.jsx(N,{id:"notes",value:b.notes,onChange:t=>u("notes",t.target.value),placeholder:"Informations supplémentaires"})]})]}),e.jsxs(P,{type:"submit",disabled:g>0||R||m.length===0,className:"gap-2",children:[e.jsx(ne,{className:"h-4 w-4"}),"Enregistrer la sortie"]})]})]})})]})})})})]})}export{Re as default};
//# sourceMappingURL=DirectOut-CQKezOdp.js.map

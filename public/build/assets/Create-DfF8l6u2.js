import{r as h,j as e,L as P,$ as D,S as I,t as q}from"./app-CQvyAInf.js";import{B as C}from"./button-qelRmArg.js";import{I as O}from"./input-Blf29Qex.js";import{L as u}from"./label-DXuQz94P.js";import{S as x,a as p,b as _,c as j,d as i}from"./select-DsVvSlVc.js";import{T as B}from"./textarea-Ck1X0zwf.js";import{A as M,X as Q}from"./app-layout-mQZNAdUE.js";import"./app-CbyD8i4Z.js";import"./index-Dh4Dnqzu.js";import"./utils-jAU0Cazi.js";import"./index-Csg-B5yo.js";import"./index-D1Z7h3vH.js";import"./createLucideIcon-CDtDhRNb.js";import"./check-3WY5HJZB.js";import"./index-B6QC96uA.js";import"./app-logo-icon-CYEPLqCw.js";import"./car-front-3ODHaHDz.js";import"./package-BH85mpxF.js";function le({produits:f,hopitals:A}){var b;const[c,m]=h.useState({}),[d,T]=h.useState({}),[n,g]=h.useState({to_hospital_id:null,to_central:!1,priorite:"moyen",from_central:!1,notes:""}),[S,N]=h.useState(!1);h.useEffect(()=>{const t={};f.forEach(r=>{t[r.id]=r.stocks.filter(a=>a.quantite>0).map(a=>{var s;return{...a,hopital_nom:((s=a.hopital)==null?void 0:s.nom)||"Stock Central"}})}),T(t)},[f]);const V=t=>{var a;const r=f.find(s=>s.id.toString()===t);if(r&&!c[t]){const s=(a=d[r.id])==null?void 0:a.find(l=>l.hopital_id===null);m(l=>({...l,[t]:{medical_produit_id:r.id,name:r.name,stocks:d[r.id]||[],quantite:1,from_central:!!s,stock_source_id:(s==null?void 0:s.id)||null,max_quantite:(s==null?void 0:s.quantite)||0}}))}},E=t=>{const r={...c};delete r[t],m(r)},w=(t,r)=>{var s;const a=(s=d[parseInt(t)])==null?void 0:s.find(l=>l.id.toString()===r);m(l=>({...l,[t]:{...l[t],stock_source_id:(a==null?void 0:a.id)||null,from_central:(a==null?void 0:a.hopital_id)===null,max_quantite:(a==null?void 0:a.quantite)||0,quantite:Math.min(l[t].quantite,(a==null?void 0:a.quantite)||1)}}))},F=t=>{t.preventDefault(),N(!0);const r=Object.values(c).map(s=>({medical_produit_id:s.medical_produit_id,quantite:s.quantite,from_central:s.from_central,stock_source_id:s.stock_source_id})),a={to_hospital_id:n.to_hospital_id,to_central:n.to_central,from_central:n.from_central,priorite:n.priorite,notes:n.notes,items:r};console.log("Payload:",a),I.post(route("transferts.store"),a,{onSuccess:()=>{q.success("Transfert créé avec succès")},onError:s=>{console.error("Validation errors:",s),q.error("Veuillez corriger les erreurs dans le formulaire")},onFinish:()=>{N(!1)}})},L=[{title:"Transfert de stock",href:"/transferts"},{title:"Nouveau Transfert",href:"/transferts/create"}];return e.jsxs(M,{breadcrumbs:L,children:[e.jsx(P,{title:"Nouveau Transfert"}),e.jsx("div",{className:"py-12",children:e.jsxs("div",{className:"mx-auto max-w-7xl sm:px-6 lg:px-8",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"Nouveau Transfert"}),e.jsxs("form",{onSubmit:F,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"to_hospital_id",children:"Destination"}),e.jsxs(x,{value:n.to_central?"central":((b=n.to_hospital_id)==null?void 0:b.toString())||"",onValueChange:t=>{g(t==="central"?{...n,to_hospital_id:null,to_central:!0,from_central:!1}:{...n,to_hospital_id:parseInt(t),to_central:!1})},children:[e.jsx(p,{children:e.jsx(_,{placeholder:"Sélectionner une destination"})}),e.jsxs(j,{children:[e.jsx(i,{value:"central",children:"Stock Central"}),A.map(t=>e.jsx(i,{value:t.id.toString(),children:t.nom},t.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"priorite",children:"Priorité"}),e.jsxs(x,{value:n.priorite,onValueChange:t=>g({...n,priorite:t}),children:[e.jsx(p,{children:e.jsx(_,{placeholder:"Sélectionner une priorité"})}),e.jsxs(j,{children:[e.jsx(i,{value:"faible",children:"Faible"}),e.jsx(i,{value:"moyen",children:"Moyen"}),e.jsx(i,{value:"eleve",children:"Élevé"}),e.jsx(i,{value:"urgent",children:"Urgent"})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"notes",children:"Notes"}),e.jsx(B,{id:"notes",value:n.notes,onChange:t=>g({...n,notes:t.target.value}),placeholder:"Informations supplémentaires..."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-lg font-medium",children:"Articles à transférer"}),e.jsxs(x,{onValueChange:V,children:[e.jsx(p,{className:"w-[250px]",children:e.jsx(_,{placeholder:"Ajouter un produit"})}),e.jsx(j,{children:f.map(t=>{var r,a;return e.jsxs(i,{value:t.id.toString(),disabled:!!c[t.id]||((r=d[t.id])==null?void 0:r.length)===0,children:[t.name,((a=d[t.id])==null?void 0:a.length)===0&&" (Stock indisponible)"]},t.id)})})]})]}),Object.values(c).length>0?e.jsx("div",{className:"space-y-4",children:Object.values(c).map(t=>{var r,a;return e.jsxs("div",{className:"p-4 border rounded-lg relative",children:[e.jsx("button",{type:"button",className:"absolute top-2 right-2 p-1 rounded-full hover:bg-gray-100",onClick:()=>E(t.medical_produit_id.toString()),children:e.jsx(Q,{className:"h-4 w-4"})}),e.jsx("h3",{className:"font-medium",children:t.name}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 mt-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(u,{children:"Quantité"}),e.jsx(O,{type:"number",min:"1",max:t.max_quantite,value:t.quantite,onChange:s=>{const l=Math.min(parseInt(s.target.value)||1,t.max_quantite);m(o=>({...o,[t.medical_produit_id]:{...o[t.medical_produit_id],quantite:l}}))}}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Disponible: ",t.max_quantite]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(u,{children:"Source"}),e.jsxs(x,{value:t.from_central?"central":"hospital",onValueChange:s=>{var y;const l=s==="central",o=(y=d[t.medical_produit_id])==null?void 0:y.find(v=>v.hopital_id===null);m(v=>({...v,[t.medical_produit_id]:{...v[t.medical_produit_id],from_central:l,stock_source_id:l?o==null?void 0:o.id:null,max_quantite:l?o==null?void 0:o.quantite:0}}))},children:[e.jsx(p,{children:e.jsx(_,{placeholder:"Sélectionner une source"})}),e.jsxs(j,{children:[e.jsx(i,{value:"central",children:"Stock Central"}),e.jsx(i,{value:"hospital",children:"Hôpital"})]})]})]}),!t.from_central&&e.jsxs("div",{className:"space-y-1",children:[e.jsx(u,{children:"Stock Source"}),e.jsxs(x,{value:((r=t.stock_source_id)==null?void 0:r.toString())||"",onValueChange:s=>w(t.medical_produit_id.toString(),s),children:[e.jsx(p,{children:e.jsx(_,{placeholder:"Sélectionner un stock"})}),e.jsx(j,{children:(a=d[t.medical_produit_id])==null?void 0:a.filter(s=>s.hopital_id!==null&&s.quantite>0).map(s=>e.jsxs(i,{value:s.id.toString(),children:[s.hopital_nom," - Lot: ",s.numero_lot||"N/A"," - Qte: ",s.quantite]},s.id))})]})]})]})]},t.medical_produit_id)})}):e.jsx("div",{className:"text-center py-8 border rounded-lg ",children:e.jsx("p",{className:"text-gray-500",children:"Aucun produit sélectionné"})})]}),e.jsxs("div",{className:"flex justify-end gap-4",children:[e.jsx(C,{variant:"outline",asChild:!0,children:e.jsx(D,{href:route("transferts.index"),children:"Annuler"})}),e.jsx(C,{type:"submit",disabled:S||Object.values(c).length===0,children:S?"Enregistrement...":"Enregistrer"})]})]})]})})]})}export{le as default};
//# sourceMappingURL=Create-DfF8l6u2.js.map
